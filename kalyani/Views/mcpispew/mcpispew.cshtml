
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="container-fluide">
    <div class="row">
        <div class="col-lg-12 panelsm">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <b>MCP/ISP/EW Data Logs</b>

                    <button style="background-color:red;float:right;height:30px;width:100px;margin-top:-5px;" onclick="clearbucketfilters();" title="CLEAR FILTER">CLEAR FILTER</button>
                </div>
                <div class="panel-body panelsm">
                    <div class="panel panel-default">
                        <div class="tab-content" id="Tabs">
                            <div class="panel panel-default" style="border-top: #fff;">
                                <div class="panel-body">
                                    <div class="row">
                                        @if (Session["DealerCode"].ToString() == "KALYANIMOTORS")
                                        {
                                            <div class="col-md-2" id="taggingdiv">
                                                <label>Taggings:</label>
                                                <select class="filter form-control" id="taggingcalls" onchange="getfilters(this);" data-column-index="12" data-field="bucketcalls" name="bucketcalls">
                                                    <option value="0">Very Hot</option>
                                                    <option value="1">Hot</option>
                                                    <option value="2">Warm</option>
                                                    <option value="3">Cold</option>
                                                    <option value="4">Very Cold</option>
                                                    <option value="5">Experts</option>
                                                    <option value="6">Professionals</option>
                                                </select>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="col-md-2" id="bucketDiv">
                                                <label>Select Buckets:</label>
                                                <select class="filter form-control" id="bucketcalls" onchange="getfilters(this);" data-column-index="12" data-field="bucketcalls" name="bucketcalls">
                                                    <option value="0">Fresh Call</option>
                                                    <option value="1">Followup</option>
                                                    <option value="2">Non Contact</option>
                                                    <option value="3">Service Booked</option>
                                                    <option value="4">service Not Required</option>
                                                    <option value="5">NonFSPMS</option>
                                                </select>
                                            </div>
                                        }

                                        <div class="col-md-2" id="typeDiv">
                                            <label>Select Catgory:</label>
                                            <select class="filter form-control" id="typeofbucket" onchange="showfilters();getfilters(this);" data-column-index="12" data-field="typeofbucket" name="typeofbucket">

                                                @if (Session["DealerCode"].ToString() == "POPULAR")
                                                {
                                                    <option value="All">All</option>
                                                    <option value="MCP">MCP</option>
                                                    <option value="EW">EW</option>
                                                    <option value="Petrol">Petrol</option>
                                                    <option value="Diesel">Diesel</option>
                                                    if (Session["UserRole1"].ToString() == "1") { 
                                                        <option value="Loyalty">Loyalty Point</option>
                                                    }
                                                    
                                                }
                                                else
                                                {
                                                    <option value="All">All</option>
                                                    <option value="MCP">MCP</option>
                                                    <option value="ISP">ISP</option>
                                                    <option value="EW">EW</option>
                                                    <option value="Loyalty">Loyalty</option>
                                                    <option value="BSC">BSC</option>
                                                    <option value="micoupon">MI-COUPON</option>
                                                }
                                            </select>
                                        </div>
                                        <div id="ISPDiv" style="display:none;">
                                            <div class="col-md-2" id="">
                                                <label>ISP From Date: </label>
                                                <input type="text" class="filter form-control datepicExpiryFromDropDown" placeholder="Enter From Date" data-column-index="1" data-field="ispfrom" onchange="getfilters(this);filtercountDisplay()" id="ispfrom" name="ispfrom" readonly>
                                            </div>
                                            <div class="col-md-2" id="">
                                                <label>ISP To Date: </label>
                                                <input type="text" class="filter form-control datepicExpiryToDropDown datepicker" placeholder="Enter To Date" data-column-index="2" data-field="ispto" onchange="getfilters(this);filtercountDisplay()" id="ispto" name="ispto" readonly>
                                            </div>
                                        </div>
                                        <div id="MCPDiv" style="display:none;">

                                            <div class="col-md-2" id="">
                                                <label>MCP From Date: </label>
                                                <input type="text" class="filter form-control datepicExpiryFromDropDown" placeholder="Enter From Date" data-column-index="1" data-field="mcpfrom" onchange="getfilters(this);filtercountDisplay()" id="mcpfrom" name="mcpfrom" readonly>
                                            </div>
                                            <div class="col-md-2" id="">
                                                <label>MCP To Date: </label>
                                                <input type="text" class="filter form-control datepicExpiryToDropDown datepicker" placeholder="Enter To Date" data-column-index="2" data-field="mcpto" onchange="getfilters(this);" id="mcpto" name="mcpto" readonly>
                                            </div>
                                        </div>
                                        <div id="EWDiv" style="display:none;">

                                            <div class="col-md-2" id="">
                                                <label>EW From Date: </label>
                                                <input type="text" class="filter form-control datepicExpiryFromDropDown" placeholder="Enter From Date" data-column-index="1" data-field="ewfrom" onchange="getfilters(this);filtercountDisplay()" id="ewfrom" name="ewfrom" readonly>
                                            </div>
                                            <div class="col-md-2" id="">
                                                <label>EW To Date: </label>
                                                <input type="text" class="filter form-control datepicExpiryToDropDown datepicker" placeholder="Enter To Date" data-column-index="2" data-field="ewto" onchange="getfilters(this);filtercountDisplay()" id="ewto" name="ewto" readonly>
                                            </div>
                                        </div>
                                        <div id="loyaltyDiv" style="display:none;">

                                            <div class="col-md-2" id="">
                                                <label>Loyalty From Date: </label>
                                                <input type="text" class="filter form-control datepicExpiryFromDropDown" placeholder="Enter From Date" data-column-index="1" data-field="loyaltyfrom" onchange="getfilters(this);filtercountDisplay()" id="loyaltyfrom" name="loyaltyfrom" readonly>
                                            </div>
                                            <div class="col-md-2" id="">
                                                <label>Loyalty To Date: </label>
                                                <input type="text" class="filter form-control datepicExpiryToDropDown datepicker" placeholder="Enter To Date" data-column-index="2" data-field="loyaltyto" onchange="getfilters(this);filtercountDisplay()" id="loyaltyto" name="loyaltyto" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                    </div>
                                </div>
                            </div>
                            <div class="panel panel-default tab-pane fade active in" id="schedule" role="tabpanel" aria-labelledby="schedule-tab">
                                <div>
                                    <table id="tblSchedule" class="table table-striped table-bordered tblIns" align="left">
                                        <thead>
                                            <tr>
                                                <th>Action</th>
                                                <th>ISP Date</th>
                                                <th>MCP Date</th>
                                                <th>OEM Warrenty Date</th>
                                                <th>Next Service Date</th>
                                                <th>Customer Name</th>
                                                <th>Chassis No.</th>
                                                <th>vehicle Regno</th>
                                                <th>Last Dispo</th>
                                                <th>bucket</th>
                                                <th>followUpDate</th>
                                                <th>followUpTime</th>
                                                <th>scheduleDate</th>
                                                <th>scheduleTime</th>
                                            </tr>
                                        </thead>

                                        <tbody align="center"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 col-sm-12">
                                    <span class="code" id="tblException" style="font-size:11pt;font-weight:bold;"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts
{

    <script type="text/javascript">
        var  filtDist = {};

        $(document).ready(function ()
        {
            showfilters();
            $('.datepicker').datepicker({
                duration: "slow",
                showOptions: { direction: "up" },
                dateFormat: 'yy-mm-dd',
                changeMonth: true,//this option for allowing user to select month
                changeYear: true //this option for allowing user to select from year range

            });

            $('.datepicExpiryFromDropDown').datepicker({
                autoclose: true,
                dateFormat: 'yy-mm-dd',
                onSelect: function (date) {
                    $('.datepicExpiryToDropDown').datepicker("destroy");
                    $('.datepicExpiryToDropDown').datepicker("destroy");
                    $('.datepicExpiryToDropDown').datepicker({
                        autoclose: true,
                        dateFormat: 'yy-mm-dd',
                        minDate: $('.datepicExpiryFromDropDown').datepicker('getDate')
                    });
                    $(this).trigger('change');var dt1 = $('.datepicExpiryFromDropDown').datepicker('getDate');
                    var dt2 = $('.datepicExpiryToDropDown').datepicker('getDate');
                    if (dt2 <= dt1) {
                        var minDate = $('#dt2').datepicker('option', 'minDate');
                        $('.datepicExpiryToDropDown').datepicker('setDate', null);
                    }
                }
            })

            $('.datepicAppointmentFromDropDown').datepicker({
                autoclose: true,
                dateFormat: 'yy-mm-dd',
                onSelect: function (date) {
                    $('.datepicAppointmentToDropDown').datepicker("destroy");
                    $('.datepicAppointmentToDropDown').datepicker("destroy");
                    $('.datepicAppointmentToDropDown').datepicker({
                        autoclose: true,
                        dateFormat: 'yy-mm-dd',
                        minDate: $('.datepicAppointmentFromDropDown').datepicker('getDate')
                    });
                    $(this).trigger('change');var dt1 = $('.datepicAppointmentFromDropDown').datepicker('getDate');
                    var dt2 = $('.datepicAppointmentToDropDown').datepicker('getDate');
                    if (dt2 <= dt1) {
                        var minDate = $('#dt2').datepicker('option', 'minDate');
                        $('.datepicAppointmentToDropDown').datepicker('setDate', null);
                    }
                }
            })


            if (localStorage.length > 0)
            {
                filtDist = JSON.parse(localStorage.getItem("Insurancefilter"));
                if (filtDist != null) {
                    renderFilterData();
                    localStorage.removeItem("Insurancefilter");

                }
                else {
                    filtDist = {};
                    bindCallData();
                }
            }
            else
            {
                bindCallData();
            }
        });

        function renderFilterData()
        {
            for (var key in filtDist) {
                if (key !== "getDataFor" && key !== "isFiltered") {
                    var element = $('.filter[data-field="' + key + '"]');
                    $(element).val(filtDist[key]);
                }
            }
            bindCallData();
        }
        function showfilters()
        {
            var typeofbucket = $('#typeofbucket').val();

            if (typeofbucket =="MCP") {
                $('#EWDiv').css({ 'display': 'none' });
                $('#MCPDiv').css({ 'display': 'block' });
                $('#ISPDiv').css({ 'display': 'none' });
                $('#loyaltyDiv').css({ 'display': 'none' });
                $('#ispfrom').val('');
                $('#ispto').val('');
                $('#ewfrom').val('');
                $('#ewto').val('');
                $('#loyaltyfrom').val('');
                $('#loyaltyto').val('');
            }
            else if (typeofbucket == "ISP") {
                $('#EWDiv').css({ 'display': 'none' });
                $('#MCPDiv').css({ 'display': 'none' });
                $('#loyaltyDiv').css({ 'display': 'none' });
                $('#ISPDiv').css({ 'display': 'block' });
                $('#ispto').val('');
                $('#mcpfrom').val('');
                $('#mcpto').val('');
                $('#ewfrom').val('');
                $('#ewto').val('');
                $('#loyaltyfrom').val('');
                $('#loyaltyto').val('');
 }
            else if (typeofbucket == "EW") {
                $('#EWDiv').css({ 'display': 'block' });
                $('#MCPDiv').css({ 'display': 'none' });
                $('#ISPDiv').css({ 'display': 'none' });
                $('#loyaltyDiv').css({ 'display': 'none' });
                $('#ispfrom').val('');
                $('#ispto').val('');
                $('#mcpfrom').val('');
                $('#mcpto').val('');
                $('#loyaltyfrom').val('');
                $('#loyaltyto').val('');
            }
            else if (typeofbucket == "Loyalty") {
                $('#EWDiv').css({ 'display': 'none' });
                $('#MCPDiv').css({ 'display': 'none' });
                $('#ISPDiv').css({ 'display': 'none' });
                $('#loyaltyDiv').css({ 'display': 'block' });
                $('#ispfrom').val('');
                $('#ispto').val('');
                $('#mcpfrom').val('');
                $('#mcpto').val('');
            }
            else {
                $('#EWDiv').css({ 'display': 'block' });
                $('#MCPDiv').css({ 'display': 'block' });
                $('#ISPDiv').css({ 'display': 'block' });
            }


        }
        function clearbucketfilters()
        {
            $('#bucketcalls').val('0');
            $('#typeofbucket').val('All');
            $('#ispfrom').val('');
            $('#ispto').val('');
            $('#mcpfrom').val('');
            $('#mcpto').val('');
            $('#ewfrom').val('');
            $('#ewto').val('');
            $('#search').val('');
            filtDist = {};
            bindCallData();
        }

        function getfilters(item) {
            var field = $(item).attr('data-field');
            var data = $(item).val();

            if (filtDist[field] === undefined) {
                filtDist[field] = data;
                if (data != "") {
                    filtDist["isFiltered"] = true;
                }
                else {

                    if (($('#bucketcalls').val() === "" || $('#taggingcalls').val() === "") &&  $('#typeofbucket').val() === "" && $('#ispfrom').val() === "" && $('#ispto').val() === "" && $('#mcpfrom').val() === "" && $('#mcpto').val() === "" && $('#ewfrom').val() === "" && $('#ewto').val() === "" && $('#search').val() === "")
                    {
                        filtDist["isFiltered"] = false;
                    }
                }
            }
            else {
                filtDist[field] = data;
                if (data != "") {
                    filtDist["isFiltered"] = true;
                }
                else if (($('#bucketcalls').val() === "" || $('#taggingcalls').val() === "") && $('#typeofbucket').val() === "" && $('#ispfrom').val() === "" && $('#ispto').val() === "" && $('#mcpfrom').val() === "" && $('#mcpto').val() === "" && $('#ewfrom').val() === "" && $('#ewto').val() === "" && $('#search').val() === "")
                {
                    filtDist["isFiltered"] = false;
                }

            }
            bindCallData();
        }

        function recordFilters() {
            localStorage.setItem("Insurancefilter", JSON.stringify(filtDist));
        }
        function bindCallData()
        {
            var table = $('#tblSchedule').dataTable({
                "destroy": true,
                "ajax": {
                    "url": siteRoot + "/mcpispew/getmcpispewDetails/",
                    "type": "POST",
                    "datatype": "json",
                    "data": { servicemcpispewData: JSON.stringify(filtDist) }
                },
                "columns": [
                    {
                        "data": "Action", render: function (data, type, row) {
                            //debugger;
                            return `<a class="fa fa-pencil-square" href="${siteRoot}/Home/redirectToCallLogging/CRE_MCP%2cS%2c${row.customer_id}%2c${row.vehicle_id}" style="font-size: 24pt;color: red;" onclick="recordFilters()"> </a>`
                        }
                    },
                    {
                        "data": "ispDate", "render": function (data, type, row) {
                            return parseJsonDateTime(data);
                        }
                    },
                    {
                        "data": "mcpdate", "render": function (data, type, row) {
                            return parseJsonDateTime(data);
                        }
                    },
                    {
                        "data": "OEMWarrentyDate", "render": function (data, type, row) {
                            return parseJsonDateTime(data);
                        }
                    },
                    {
                        "data": "nextServiceDate", "render": function (data, type, row) {
                            return parseJsonDateTime(data);
                        }
                    },
                    { "data": "customername", "name": "customername" },
                    { "data": "chassisno", "name": "chassisno" },
                    { "data": "vehicleRegno", "name": "vehicleRegno" },
                    { "data": "lastdispo", "name": "lastdispo" },
                    { "data": "bucket", "name": "bucket" },
                    { "data": "followUpDate", "name": "followUpDate" },
                    { "data": "followUpTime", "name": "followUpTime" },
                    { "data": "scheduleDate", "name": "scheduleDate" },
                    { "data": "scheduleTime", "name": "scheduleTime" }
                ],
                "responsive": true,
                columnDefs: [
                    { className: 'compact' }
                ],
                "initComplete": function (data) {
                    console.log(+data.json.filterls); $('#tblException').text(data.json.exception);

                },
                "serverSide": "true",
                "processing": "true",
                "serverSide": true,
                "scrollY": "300",
                "paging": true,
                "searching": true,
                "lengthMenu": [100, 200, 500, 1000],
                "pageLength": 100,
                "language": {
                    "processing": "Loading Please Wait.....!"
                },
                "fnRowCallback": function (nRow, aData, iDisplayIndex) {
                    $('td', nRow).attr('nowrap', 'nowrap');
                    return nRow;
                }
            });
        }
    </script>
}
