
@{
    ViewBag.Title = "SAROLog";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    .table {
        table-layout: auto !important;
        width: 100% !important;
        max-width: none !important;
    }

    .tbodycls {
        text-align: center;
    }

    @@media only screen and (max-width: 768px) {
        /* For mobile phones: */
        .dataTables_scroll {
            overflow-x: hidden !important;
            overflow-y: scroll !important;
        }

        .dataTables_scrollBody {
            overflow-x: hidden !important;
            overflow-y: scroll !important;
            margin-left: 18px !important;
        }

        .dataTables_scrollHeadInner {
            width: 300px !important
        }

        .tbodycls {
            text-align: left !important;
        }
    }
</style>
<div class="container-fluide">
    <div class="row">
        <div class="col-lg-12 panelsm">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <b>Repair Order Log</b>
                    <button style="background-color:red;float:right;height:30px;width:100px;margin-top:-5px;" onclick="clearbucketfilters();" title="CLEAR FILTER">CLEAR</button>
                </div>
                <div class="panel-body">
                    <div class="panel panel-default">
                        <div class="tab-content" id="Tabs">
                            <div class="panel panel-default" style="border-top: #fff;">
                                <div class="panel-body">
                                    <div class="row">
                                        <div class="col-sm-2" id="roworkTypeDiv">
                                            <div class="form-group">
                                                <label>Work Type: </label>
                                                @Html.DropDownList("roworkType", new SelectList(ViewBag.workType, "id", "workType"), "Select", new { @class = "filter form-control", @id = "roworkType", @data_field = "roworkType", @onchange = "getfilters(this);" })
                                            </div>
                                        </div>
                                        <div class="col-sm-2" id="rodateDiv">
                                            <div class="form-group">
                                                <label>RO Date: </label>
                                                <input type="text" class="datepicker filter form-control" id="roDate" data-field="roDate" onchange="getfilters(this);" />
                                            </div>
                                        </div>
                                        <div class="col-sm-2" id="roStatusDiv">
                                            <label>Status:</label>
                                            <select class="filter form-control" id="roStatus" onchange="getfilters(this);" data-column-index="2" data-field="roStatus" name="roStatus">
                                                <option value="">--Select--</option>
                                                <option value="OPEN">OPEN</option>
                                                <option value="CLOSED">CLOSED</option>
                                                <option value="BILLED">BILLED</option>
                                                <option value="DELIVERED">DELIVERED</option>
                                                <option value="CANCEL">CANCEL</option>
                                            </select>
                                        </div>
                                        <div class="col-sm-2" id="roPDTDiv">
                                            <div class="form-group">
                                                <label>PDT: </label>
                                                <input type="text" class="datepicker filter form-control" id="PDT" data-field="PDT" onchange="getfilters(this);" />
                                            </div>
                                        </div>
                                        <div class="col-sm-2" id="roPRUDiv">
                                            <div class="form-group">
                                                <label>Pending Reason Update: </label>
                                                @Html.DropDownList("roworkType", new SelectList(ViewBag.pendingReason, "pendingReason", "pendingReason"), "Select", new { @class = "filter form-control", @id = "PRU", @data_field = "PRU", @onchange = "getfilters(this);" })
                                            </div>
                                        </div>
                                        @*<div class="col-sm-2" id="saservicetypesDiv">
                                            <div class="form-group">
                                                <label>Sa Service Type: </label>
                                                @Html.DropDownList("saservicetypes", new SelectList(ViewBag.saservicetypes, "saservicetypes", "saservicetypes"), "Select", new { @class = "filter form-control", @id = "saservicetypes", @data_field = "saservicetypes", @onchange = "getfilters(this);" })
                                            </div>
                                        </div>*@
                                    </div>
                                </div>
                            </div>
                            <div class="panel panel-default tab-pane fade active in" id="allRO" role="tabpanel" aria-labelledby="allRO-tab">
                                <div class="dataTable_wrapper">
                                    <table class="table table-striped table-bordered table-hover" width="100%" id="tblallRO">
                                        <thead>
                                            <tr>
                                                <th style="text-align:center;">Action</th>
                                                <th style="text-align:center;">Reg No</th>
                                                <th style="text-align:center;">R/O Date</th>
                                                <th style="text-align:center;">WorkType</th>
                                                <th style="text-align:center;">PDT</th>
                                                <th style="text-align:center;">Name</th>
                                                <th style="text-align:center;">VIN</th>
                                                <th style="text-align:center;">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody class="tbodycls"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 col-sm-12">
                                    <span class="code" id="tblException" style="font-size:11pt;font-weight:bold;"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@section scripts
{
    @if (ViewBag.dispositionResult != null && ViewBag.dispoError == false)
    {
        <script type="text/javascript">
        Lobibox.notify('info', {
            delay: 4 * 200,
            msg: '@ViewBag.dispositionResult'
        });
        </script>
    }

    @if (ViewBag.dispositionResult != null && ViewBag.dispoError == true)
    {
        <script type="text/javascript">
        Lobibox.notify('info', {
            delay: 4 * 7000,
            msg: '@ViewBag.dispositionResult'
        });
        </script>
    }

    <script type="text/javascript">

        var  filtDist = {}, callAjaxClear = 0, callfromTab = 0;

        $(document).ready(function () {

        if (localStorage.length > 0) {
            filtDist = JSON.parse(localStorage.getItem("repairOrderfilter"));
            if (filtDist != null) {
                renderFilterData();
                localStorage.removeItem("repairOrderfilter");
            }
            else {
                filtDist = {};
                bindallRODetails();
            }
        }
        else {
            bindallRODetails();

            }

            $('.datepicker').datepicker({
                duration: "slow",
                showOptions: { direction: "up" },
                dateFormat: 'yy-mm-dd',
                changeMonth: true,//this option for allowing user to select month
                changeYear: true //this option for allowing user to select from year range

            });


    });
    function renderFilterData() {
        for (var key in filtDist) {
            if (key !== "isFiltered") {
                var element = $('.filter[data-field="' + key + '"]');
                $(element).val(filtDist[key]);
            }
        }
            bindallRODetails();
    }

    function clearbucketfilters() {
        $('#roworkType').prop('selectedIndex', 0);
        $('#roStatus').prop('selectedIndex', 0);
        $('#PRU').prop('selectedIndex', 0);
        $('#search').val('');
        $('#roDate').val('');
        $('#PDT').val('');
        filtDist = {};
        bindallRODetails();
    }
        function getfilters(item) {
        var field = $(item).attr('data-field');
            var data = $(item).val();

        if (filtDist[field] === undefined) {
            filtDist[field] = data;
            if (data != "") {
                filtDist["isFiltered"] = true;
            }
            else {
                if ($('#roworkType').val() === "" && $('#roStatus').val() === "" && $('#roDate').val() === "" && $('#PDT').val() === "" && $('#PRU').val() === "" && $('#search').val() === "")
                {
                    filtDist["isFiltered"] = false;
                }
            }
        }
        else {
            filtDist[field] = data;
            if (data != "") {
                filtDist["isFiltered"] = true;
            }
            if ($('#roworkType').val() === "" && $('#roStatus').val() === "" && $('#roDate').val() === "" && $('#PDT').val() === "" && $('#PRU').val() === "" && $('#search').val() === "")
            {
                filtDist["isFiltered"] = false;
            }

        }
            bindallRODetails();
    }


    function recordFilters() {
        localStorage.setItem("repairOrderfilter", JSON.stringify(filtDist));
    }

    function bindallRODetails() {
        filtDist["getDataFor"] = 1;
        var table = $('#tblallRO').DataTable({
            "destroy": true,
            "ajax": {
                "url": siteRoot + "/SAROLog/GetBucketData/",
                "type": "POST",
                "datatype": "json",
                "data": { repairorderData: JSON.stringify(filtDist) }
            },
            "columns": [
                {
                    "data": "Action", render: function (data, type, row) {
                        //return `<a class="fa fa-pencil-square" href="${siteRoot}/SACallLogging/SACallLogging/SA%2cS%2c${row.customer_id}%2c${row.vehicle_id}" style="font-size: 24pt;color: red;" onclick="recordFilters()"> </a>`
                        return `<a class="fa fa-pencil-square" href="${siteRoot}/SACallLogging/SACallLogging/SA%2cS%2c${row.customer_id}%2c${row.vehicle_id}%2c${row.id}" style="font-size: 24pt;color: red;" onclick="recordFilters()"> </a>`
                    }
                },
                { "data": "vehiclereg_no", "name": "vehiclereg_no" },
                {
                    "data": "rodate", render: function (data, type, row) {
                        return parseJsonDateTime(data);
                    }
                },
                { "data": "servicetype", "name": "servicetype" },
                {
                    "data": "pdt", render: function (data, type, row) {
                        return reverDate(data);
                    }
                },
                { "data": "customername", "name": "customername" },
                { "data": "chassisno", "name": "chassisno" },
                { "data": "rostatus", "name": "rostatus" }

            ],
            "rowCallback": function (row, data) {
                var saledate = parseJsonDateTime(data.saledate);
                var rodate = parseJsonDateTime(data.rodate);

                var start = new Date(saledate.split("-").reverse().join("-"));
                var end = new Date(rodate.split("-").reverse().join("-"));

                var diffDate = (end - start);
                var years = Math.floor(diffDate / 31536000000);

                if (years < 1)
                {
                    $(row).css({ "background-color": "#ffe6e6" })

                }
                else if (years >= 1 && years < 3) {
                    $(row).css({ "background-color": "#ffff4d" })

                }
                else if (years >= 3 && years < 4) {
                    $(row).css({ "background-color": "#b3ffb3" })
                }

            },
            responsive: screen.width < 500 ? true : false,
            fixedColumns: true, fixedHeader: true,
            "initComplete": function (data) {
                $('#tblException').text(data.json.exception);
            },
            "serverSide": "true",
            "processing": "true",
         "serverSide": "true",
         "scrollX": "true",
            "scrollY": "300",
            "paging": "true",
            "searching": "true",
            "language": {
                "processing": "Loading Please Wait.....!"
            }
        });
        }

    </script>
}
